#!/bin/bash
function finish {
    sync_unlock.sh
}
if [ -z "$TRAP" ]
then
  sync_lock.sh || exit -1
  trap finish EXIT
  export TRAP=1
fi
set -o pipefail
> errors.txt
> run.log
GHA2DB_PROJECT=beam PG_DB=beam GHA2DB_LOCAL=1 ./structure 2>>errors.txt | tee -a run.log || exit 1
sudo -u postgres psql beam -c "create extension if not exists pgcrypto" || exit 1
./devel/ro_user_grants.sh beam || exit 2
GHA2DB_EXCLUDE_REPOS='apache/activemq-nms-amqp,apache/commons-exec,apache/commons-logging,apache/cordova-plugin-battery-status,apache/cordova-plugin-dialogs,apache/couchdb-couch,apache/ctakes,apache/deltaspike,apache/flex-blazeds,apache/flex-site,apache/geronimo-javamail,apache/geronimo-jwt-auth,apache/geronimo-microprofile,apache/incubator-dubbo-rpc-jsonrpc,apache/incubator-sdap-ningesterpy,apache/incubator-wave-android,apache/jackrabbit-filevault-package-maven-plugin,apache/karaf-decanter,apache/log4j-extras,apache/madlib-site,apache/maven-common-artifact-filters,apache/maven-filtering,apache/maven-pmd-plugin,apache/maven-scm-publish-plugin,apache/maven-shared-incremental,apache/odftoolkit,apache/predictionio-template-java-ecom-recommender,apache/predictionio-template-recommender,apache/qpid-broker-j,apache/sling-org-apache-sling-models-impl,apache/sling-org-apache-sling-scripting-sightly-testing,apache/sling-org-apache-sling-scripting-sightly-testing-content,apache/sling-org-apache-sling-xss,apache/sling-slingfeature-maven-plugin,apache/velocity-tools,apache/aries-jpa,apache/arrow-site,apache/calcite-avatica-go,apache/commons-beanutils,apache/commons-build-plugin,apache/commons-email,apache/commons-math,apache/commons-numbers,apache/cordova,apache/cordova-coho,apache/cordova-contribute,apache/cordova-create,apache/cordova-firefoxos,apache/cordova-node-xcode,apache/cordova-plugin-compat,apache/cordova-plugin-console,apache/cordova-plugin-globalization,apache/cordova-plugins,apache/cordova-registry,apache/cordova-serve,apache/couchdb-rebar,apache/creadur-tentacles,apache/flex-sdk,apache/fop,apache/groovy-examples,apache/hadoop-mapreduce,apache/incubator-annotator-website,apache/incubator-htrace,apache/incubator-netbeans-jackpot30,apache/incubator-openwhisk-package-cloudant,apache/incubator-s2graph,apache/incubator-sdap-mudrod,apache/incubator-sdap-nexus,apache/incubator-sdap-ningester,apache/infrastructure-puppet-kitchen,apache/isis,apache/jspwiki,apache/kafka-site,apache/karaf-cave,apache/logging-log4j-audit,apache/logging-log4php,apache/maven-artifact-transfer,apache/maven-assembly-plugin,apache/maven-clean-plugin,apache/maven-dist-tool,apache/maven-doxia-sitetools,apache/maven-ejb-plugin,apache/maven-file-management,apache/maven-fluido-skin,apache/maven-parent,apache/mnemonic,apache/myfaces,apache/myfaces-master-pom,apache/mynewt-blinky,apache/mynewt-newtmgr,apache/mynewt-site,apache/portals-pluto,apache/servicemix-bundles,apache/sling-org-apache-sling-commons-jcr-file,apache/sling-org-apache-sling-installer-core,apache/sling-org-apache-sling-installer-factory-configuration,apache/sling-org-apache-sling-jcr-filetransfer,apache/sling-org-apache-sling-launchpad-testing,apache/sling-org-apache-sling-launchpad-testing-war,apache/sling-tooling-jenkins,apache/streams,apache/streams-examples,apache/struts-master,apache/systemml-website,apache/tiles,apache/usergrid-javascript,apache/xalan-j,apache/accumulo,apache/accumulo-testing,apache/activemq,apache/activemq-apollo,apache/activemq-artemis,apache/airavata,apache/airavata-django-portal,apache/airavata-php-gateway,apache/airavata-sandbox,apache/allura,apache/ambari,apache/ant,apache/ant-ivy,apache/any23,apache/apex-core,apache/apex-malhar,apache/apr,apache/apreq,apache/apr-iconv,apache/apr-util,apache/archiva,apache/aries,apache/aries-jax-rs-whiteboard,apache/arrow,apache/arrow-testing,apache/asterixdb,apache/asterixdb-bad,apache/atlas,apache/aurora,apache/avro,apache/axis2-c,apache/axis2-java,apache/bahir-flink,apache/batik,apache/beam-site,apache/beam-wheels,apache/bigtop,apache/bookkeeper,apache/brooklyn-docs,apache/brooklyn-library,apache/brooklyn-server,apache/brooklyn-ui,apache/bval,apache/calcite,apache/calcite-avatica,apache/camel,apache/carbondata,apache/carbondata-site,apache/cassandra,apache/cassandra-dtest,apache/cayenne,apache/cayenne-website,apache/chemistry-cmislib,apache/clerezza,apache/climate,apache/cloudstack,apache/cloudstack-cloudmonkey,apache/cloudstack-docs,apache/cloudstack-docs-admin,apache/cloudstack-docs-install,apache/cloudstack-docs-rn,apache/cloudstack-documentation,apache/cloudstack-www,apache/comdev-projects,apache/comdev-reporter,apache/commons-bcel,apache/commons-cli,apache/commons-codec,apache/commons-collections,apache/commons-compress,apache/commons-configuration,apache/commons-crypto,apache/commons-csv,apache/commons-daemon,apache/commons-dbcp,apache/commons-dbutils,apache/commons-fileupload,apache/commons-imaging,apache/commons-io,apache/commons-jcs,apache/commons-jexl,apache/commons-lang,apache/commons-net,apache/commons-ognl,apache/commons-parent,apache/commons-pool,apache/commons-release-plugin,apache/commons-rng,apache/commons-text,apache/commons-validator,apache/commons-vfs,apache/commons-weaver,apache/cordova-android,apache/cordova-app-harness,apache/cordova-cli,apache/cordova-common,apache/cordova-discuss,apache/cordova-docs,apache/cordova-fetch,apache/cordova-ios,apache/cordova-js,apache/cordova-lib,apache/cordova-osx,apache/cordova-paramedic,apache/cordova-plugin-camera,apache/cordova-plugin-contacts,apache/cordova-plugin-device,apache/cordova-plugin-device-motion,apache/cordova-plugin-device-orientation,apache/cordova-plugin-file,apache/cordova-plugin-file-transfer,apache/cordova-plugin-geolocation,apache/cordova-plugin-inappbrowser,apache/cordova-plugin-media,apache/cordova-plugin-media-capture,apache/cordova-plugin-network-information,apache/cordova-plugin-screen-orientation,apache/cordova-plugin-splashscreen,apache/cordova-plugin-statusbar,apache/cordova-plugin-test-framework,apache/cordova-plugin-whitelist,apache/cordova-plugin-wkwebview-engine,apache/cordova-plugman,apache/cordova-status,apache/cordova-tizen,apache/cordova-weinre,apache/cordova-windows,apache/couchdb,apache/couchdb-ci,apache/couchdb-docker,apache/couchdb-documentation,apache/couchdb-fauxton,apache/couchdb-nano,apache/couchdb-pkg,apache/couchdb-query-server-node,apache/couchdb-www,apache/creadur-whisker,apache/curator,apache/cxf,apache/cxf-fediz,apache/derby,apache/directmemory,apache/directory-fortress-core,apache/directory-kerby,apache/directory-ldap-api,apache/directory-project,apache/directory-scimple,apache/directory-server,apache/directory-studio,apache/distributedlog,apache/drat,apache/drill,apache/drill-site,apache/eagle,apache/falcon,apache/felix,apache/fineract,apache/fineract-cn-accounting,apache/fineract-cn-anubis,apache/fineract-cn-api,apache/fineract-cn-async,apache/fineract-cn-cassandra,apache/fineract-cn-cheques,apache/fineract-cn-command,apache/fineract-cn-crypto,apache/fineract-cn-customer,apache/fineract-cn-data-jpa,apache/fineract-cn-default-setup,apache/fineract-cn-demo-server,apache/fineract-cn-deposit-account-management,apache/fineract-cn-fims-e2e,apache/fineract-cn-fims-web-app,apache/fineract-cn-group,apache/fineract-cn-group-finance,apache/fineract-cn-identity,apache/fineract-cn-lang,apache/fineract-cn-mariadb,apache/fineract-cn-mobile,apache/fineract-cn-notifications,apache/fineract-cn-office,apache/fineract-cn-payroll,apache/fineract-cn-permitted-feign-client,apache/fineract-cn-portfolio,apache/fineract-cn-provisioner,apache/fineract-cn-reporting,apache/fineract-cn-rhythm,apache/fineract-cn-service-starter,apache/fineract-cn-stellar-bridge,apache/fineract-cn-teller,apache/fineract-cn-template,apache/fineract-cn-test,apache/fineract-site,apache/flex-utilities,apache/flink,apache/flink-web,apache/flume,apache/fluo,apache/fluo-recipes,apache/fluo-uno,apache/freemarker,apache/freemarker-online-tester,apache/geode,apache/geode-examples,apache/geode-native,apache/geronimo-config,apache/geronimo-jcache-simple,apache/geronimo-specs,apache/giraph,apache/gora,apache/groovy,apache/guacamole-client,apache/guacamole-manual,apache/guacamole-server,apache/hadoop,apache/hadoop-common,apache/hadoop-hdfs,apache/hbase,apache/hbase-connectors,apache/helix,apache/hive,apache/httpasyncclient,apache/httpcomponents-client,apache/httpcomponents-core,apache/httpd,apache/ignite,apache/ignite-teamcity-bot,apache/impala,apache/incubator,apache/incubator-airflow,apache/incubator-airflow-ci,apache/incubator-annotator,apache/incubator-blur,apache/incubator-crail-website,apache/incubator-daffodil,apache/incubator-daffodil-site,apache/incubator-druid,apache/incubator-dubbo,apache/incubator-dubbo-docs,apache/incubator-dubbo-ops,apache/incubator-dubbo-spring-boot-project,apache/incubator-dubbo-website,apache/incubator-echarts,apache/incubator-edgent,apache/incubator-gearpump,apache/incubator-gobblin,apache/incubator-gossip,apache/incubator-griffin,apache/incubator-hawq,apache/incubator-hawq-site,apache/incubator-heron,apache/incubator-hivemall,apache/incubator-livy,apache/incubator-mxnet,apache/incubator-mxnet-site,apache/incubator-nemo,apache/incubator-netbeans,apache/incubator-netbeans-html4j,apache/incubator-netbeans-website,apache/incubator-omid,apache/incubator-openwhisk,apache/incubator-openwhisk-apigateway,apache/incubator-openwhisk-catalog,apache/incubator-openwhisk-cli,apache/incubator-openwhisk-client-go,apache/incubator-openwhisk-client-js,apache/incubator-openwhisk-deploy-kube,apache/incubator-openwhisk-deploy-openshift,apache/incubator-openwhisk-devtools,apache/incubator-openwhisk-external-resources,apache/incubator-openwhisk-package-alarms,apache/incubator-openwhisk-package-kafka,apache/incubator-openwhisk-package-pushnotifications,apache/incubator-openwhisk-release,apache/incubator-openwhisk-runtime-ballerina,apache/incubator-openwhisk-runtime-docker,apache/incubator-openwhisk-runtime-go,apache/incubator-openwhisk-runtime-java,apache/incubator-openwhisk-runtime-nodejs,apache/incubator-openwhisk-runtime-php,apache/incubator-openwhisk-runtime-python,apache/incubator-openwhisk-runtime-ruby,apache/incubator-openwhisk-runtime-swift,apache/incubator-openwhisk-website,apache/incubator-openwhisk-wskdeploy,apache/incubator-pagespeed-cpanel,apache/incubator-pagespeed-mod,apache/incubator-pagespeed-ngx,apache/incubator-plc4x,apache/incubator-ponymail,apache/incubator-pulsar,apache/incubator-quickstep,apache/incubator-ratis,apache/incubator-rya,apache/incubator-samoa,apache/incubator-servicecomb-docs,apache/incubator-servicecomb-java-chassis,apache/incubator-servicecomb-saga,apache/incubator-servicecomb-service-center,apache/incubator-servicecomb-website,apache/incubator-singa,apache/incubator-skywalking,apache/incubator-skywalking-data-collect-protocol,apache/incubator-skywalking-oal-tool,apache/incubator-skywalking-ui,apache/incubator-slider,apache/incubator-spot,apache/incubator-superset,apache/incubator-taverna-language,apache/incubator-taverna-mobile,apache/incubator-tephra,apache/incubator-toree,apache/incubator-toree-website,apache/incubator-unomi,apache/incubator-wave,apache/incubator-weex,apache/incubator-weex-site,apache/infrastructure-puppet,apache/jackrabbit,apache/jackrabbit-filevault,apache/jackrabbit-oak,apache/james-jsieve,apache/james-project,apache/jena,apache/jmeter,apache/juddi,apache/juneau,apache/juneau-website,apache/kafka,apache/karaf,apache/karaf-site,apache/knox,apache/kudu,apache/kylin,apache/libcloud,apache/log4j,apache/logging-log4cxx,apache/logging-log4j2,apache/logging-log4net,apache/lucenenet,apache/lucene-solr,apache/madlib,apache/mahout,apache/manifoldcf,apache/manifoldcf-integration-elasticsearch-5.5,apache/maven,apache/maven-apache-parent,apache/maven-archetype,apache/maven-compiler-plugin,apache/maven-dependency-plugin,apache/maven-deploy-plugin,apache/maven-doxia,apache/maven-ear-plugin,apache/maven-enforcer,apache/maven-indexer,apache/maven-install-plugin,apache/maven-jarsigner-plugin,apache/maven-javadoc-plugin,apache/maven-jenkins-env,apache/maven-jenkins-lib,apache/maven-jlink-plugin,apache/maven-jxr,apache/maven-patch-plugin,apache/maven-plugins,apache/maven-plugin-tools,apache/maven-project-info-reports-plugin,apache/maven-rar-plugin,apache/maven-release,apache/maven-resources-plugin,apache/maven-scm,apache/maven-shade-plugin,apache/maven-site,apache/maven-site-plugin,apache/maven-source-plugin,apache/maven-sources,apache/maven-surefire,apache/maven-toolchains-plugin,apache/maven-verifier,apache/maven-verifier-plugin,apache/maven-wagon,apache/maven-war-plugin,apache/meecrowave,apache/mesos,apache/mesos-site,apache/metamodel,apache/metron,apache/mina,apache/mina-sshd,apache/myfaces-tobago,apache/mynewt-core,apache/mynewt-documentation,apache/mynewt-mcumgr,apache/mynewt-mcumgr-cli,apache/mynewt-newt,apache/mynewt-nimble,apache/nano,apache/nifi,apache/nifi-fds,apache/nifi-minifi,apache/nifi-minifi-cpp,apache/nifi-registry,apache/nifi-site,apache/nutch,apache/ofbiz,apache/ofbiz-framework,apache/ofbiz-plugins,apache/olingo-odata2,apache/olingo-odata4,apache/oltu,apache/oodt,apache/oozie,apache/openjpa,apache/openmeetings,apache/opennlp,apache/openoffice,apache/openwebbeans,apache/orc,apache/parquet-cpp,apache/parquet-format,apache/parquet-mr,apache/parquet-testing,apache/pdfbox,apache/pdfbox-docs,apache/pdfbox-jbig2,apache/phoenix,apache/pig,apache/pivot,apache/poi,apache/polygene-java,apache/predictionio,apache/predictionio-sdk-java,apache/predictionio-sdk-ruby,apache/qpid,apache/qpid-cpp,apache/qpid-dispatch,apache/qpid-jms,apache/qpid-proton,apache/qpid-proton-j,apache/qpid-site,apache/rampart,apache/ranger,apache/reef,apache/rocketmq,apache/rocketmq-externals,apache/rocketmq-site,apache/roller,apache/royale-asjs,apache/royale-compiler,apache/royale-docs,apache/samza,apache/samza-hello-samza,apache/santuario-java,apache/sentry,apache/servicemix,apache/shiro,apache/shiro-site,apache/sirona,apache/sis,apache/sling-aggregator,apache/sling-maven-sling-plugin,apache/sling-old-svn-mirror,apache/sling-org-apache-sling-api,apache/sling-org-apache-sling-app-cms,apache/sling-org-apache-sling-bundleresource-impl,apache/sling-org-apache-sling-commons-log,apache/sling-org-apache-sling-datasource,apache/sling-org-apache-sling-discovery-oak,apache/sling-org-apache-sling-distribution-core,apache/sling-org-apache-sling-dynamic-include,apache/sling-org-apache-sling-feature,apache/sling-org-apache-sling-feature-analyser,apache/sling-org-apache-sling-feature-applicationbuilder,apache/sling-org-apache-sling-feature-io,apache/sling-org-apache-sling-feature-karaf,apache/sling-org-apache-sling-feature-launcher,apache/sling-org-apache-sling-feature-modelconverter,apache/sling-org-apache-sling-installer-it,apache/sling-org-apache-sling-jcr-contentparser,apache/sling-org-apache-sling-jcr-jackrabbit-accessmanager,apache/sling-org-apache-sling-jcr-jackrabbit-usermanager,apache/sling-org-apache-sling-karaf-features,apache/sling-org-apache-sling-launchpad-base,apache/sling-org-apache-sling-launchpad-integration-tests,apache/sling-org-apache-sling-launchpad-test-services,apache/sling-org-apache-sling-resourcebuilder,apache/sling-org-apache-sling-resource-filter,apache/sling-org-apache-sling-resourceresolver,apache/sling-org-apache-sling-scripting-sightly,apache/sling-org-apache-sling-servlets-get,apache/sling-org-apache-sling-starter,apache/sling-org-apache-sling-testing-caconfig-mock-plugin,apache/sling-org-apache-sling-testing-jcr-mock,apache/sling-org-apache-sling-testing-osgi-mock,apache/sling-org-apache-sling-testing-resourceresolver-mock,apache/sling-org-apache-sling-testing-sling-mock,apache/sling-org-apache-sling-testing-sling-mock-oak,apache/sling-samples,apache/sling-site,apache/sling-slingstart-maven-plugin,apache/sling-tooling-release,apache/sling-whiteboard,apache/spamassassin,apache/spark,apache/spark-website,apache/sqoop,apache/stanbol,apache/storm,apache/stratos,apache/struts,apache/struts-examples,apache/struts-site,apache/subversion,apache/syncope,apache/systemml,apache/tajo,apache/tcl-moddtcl,apache/tcl-modtcl,apache/tcl-rivet,apache/tcl-site,apache/tez,apache/thrift,apache/tika,apache/tinkerpop,apache/tomcat,apache/tomcat70,apache/tomcat80,apache/tomcat85,apache/tomcat-connectors,apache/tomcat-native,apache/tomee,apache/trafficcontrol,apache/trafficserver,apache/trafodion,apache/turbine-archetypes,apache/turbine-core,apache/twill,apache/uima-ducc,apache/uima-uimafit,apache/usergrid,apache/velocity-engine,apache/webservices-axiom,apache/whimsy,apache/wicket,apache/wss4j,apache/xerces2-j,apache/xmlbeans,apache/yetus,apache/zeppelin,apache/zookeeper' GHA2DB_PROJECT=beam PG_DB=beam GHA2DB_LOCAL=1 ./gha2db 2018-08-20 0 today now 'apache' 2>>errors.txt | tee -a run.log || exit 3
GHA2DB_PROJECT=beam PG_DB=beam GHA2DB_LOCAL=1 GHA2DB_MGETC=y GHA2DB_SKIPTABLE=1 GHA2DB_INDEX=1 ./structure 2>>errors.txt | tee -a run.log || exit 4
GHA2DB_PROJECT=beam PG_DB=beam ./shared/setup_repo_groups.sh 2>>errors.txt | tee -a run.log || exit 5
GHA2DB_PROJECT=beam PG_DB=beam ./shared/setup_scripts.sh 2>>errors.txt | tee -a run.log || exit 6
GHA2DB_PROJECT=beam PG_DB=beam ./shared/import_affs.sh 2>>errors.txt | tee -a run.log || exit 7
GHA2DB_PROJECT=beam PG_DB=beam GHA2DB_LOCAL=1 ./vars || exit 8
